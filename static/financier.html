<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–†–∞–±–æ—á–µ–µ –º–µ—Å—Ç–æ –§–∏–Ω–∞–Ω—Å–∏—Å—Ç–∞</title>
<link rel="stylesheet" href="style.css">
<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º FontAwesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
/* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
.upload-area {
    display: flex;
    flex-direction: column;
    gap: 15px;
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    border: 1px dashed #ccc;
}
.upload-row {
    display: flex;
    gap: 15px;
    align-items: center;
    width: 100%;
}
.upload-result-box {
    margin-top: 15px;
    display: none;
    animation: fadeIn 0.3s ease-in-out;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}
.pagination {
    margin-top: 15px;
    display: flex;
    align-items: center;
    gap: 15px;
    justify-content: center;
}
.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}
#userSearchInput {
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    min-width: 200px;
}
.account-selector {
    display: flex;
    gap: 20px;
    margin-bottom: 5px;
    align-items: center;
}
.radio-label {
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 5px;
    font-weight: 600;
}
</style>
</head>
<body>
<div id="toast-container"></div>
<div class="container">
    <header class="app-header">
        <div class="header-brand">
             <div class="brand-icon">üí∞</div>
             <div>
                 <h1>–§–∏–Ω–∞–Ω—Å—ã –ñ–ö–•</h1>
                 <span class="header-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—á–µ—Ç–∞–º–∏</span>
             </div>
        </div>
        <div class="header-profile">
            <div class="admin-info">
                <span id="financierName" style="font-weight:600;">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                <span class="role-badge financier">–§–∏–Ω–∞–Ω—Å–∏—Å—Ç</span>
            </div>
            <!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è -->
            <button id="btnOpenFinancierProfile" class="action-btn secondary-btn" style="margin-right: 10px; background: #374151; color: white;">
                ‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª—å
            </button>
            <button class="logout-btn">
                <span>–í—ã–π—Ç–∏</span>
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </button>
        </div>
    </header>

    <div class="nav-tabs-container">
        <div class="tabs">
            <button class="tab-btn active" data-tab="debts">üìâ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–∞–º–∏</button>
            <button class="tab-btn" data-tab="users">üë• –õ–∏—á–Ω—ã–π —Å–æ—Å—Ç–∞–≤</button>
        </div>
    </div>


    <!-- TAB: IMPORT -->
    <div id="debts" class="tab-content active">
        <div class="card" style="border-left:5px solid #8e44ad">
            <div class="card-header" style="border-bottom: none; padding-bottom: 0; margin-bottom: 10px;">
                <h3>üìÇ –ò–º–ø–æ—Ä—Ç –∏–∑ 1–° (Excel)</h3>
            </div>
            <p style="color:#666;font-size:14px;margin-bottom:15px">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª "–û–±–æ—Ä–æ—Ç–Ω–æ-—Å–∞–ª—å–¥–æ–≤–∞—è –≤–µ–¥–æ–º–æ—Å—Ç—å" (.xlsx).<br>–°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–∏—Ç —Å–∞–ª—å–¥–æ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å—á–µ—Ç–∞.</p>
            <div class="upload-area">
                <div class="account-selector">
                    <span style="font-weight:bold">1. –í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç:</span>
                    <label class="radio-label"><input type="radio" name="accountType" value="209" checked> <span style="color:#27ae60">209 (–ö–æ–º–º—É–Ω–∞–ª–∫–∞)</span></label>
                    <label class="radio-label"><input type="radio" name="accountType" value="205"> <span style="color:#e67e22">205 (–ù–∞–π–º)</span></label>
                </div>
                <div class="upload-row">
                    <span style="font-weight:bold;min-width:120px">2. –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª:</span>
                    <input type="file" id="debtFile1C" accept=".xlsx,.xls" style="flex:1;padding:5px;border:1px solid #ddd;border-radius:4px">
                    <button id="btnUploadDebts" class="action-btn" style="background:#8e44ad">‚¨Ü –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                </div>
            </div>
            <div id="uploadResult" class="upload-result-box"></div>
        </div>
        <div class="card">
            <div class="card-header">
                <h3>‚ÑπÔ∏è –°–ø—Ä–∞–≤–∫–∞ –ø–æ –∏–º–ø–æ—Ä—Ç—É</h3>
            </div>
            <ul style="color:#555;font-size:13px;padding-left:20px; margin-top: 10px;">
                <li style="margin-bottom: 5px;">–§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å –§–ò–û, –î–µ–±–µ—Ç (–î–æ–ª–≥) –∏ –ö—Ä–µ–¥–∏—Ç (–ü–µ—Ä–µ–ø–ª–∞—Ç–∞).</li>
                <li style="margin-bottom: 5px;">–ò–º–ø–æ—Ä—Ç –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –º–µ—Å—è—Ü–∞.</li>
                <li>–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ –§–ò–û (–¥–æ–ø—É—Å–∫–∞—é—Ç—Å—è –Ω–µ–±–æ–ª—å—à–∏–µ —Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏—è).</li>
            </ul>
        </div>
    </div>

    <!-- TAB: USERS -->
    <div id="users" class="tab-content">
        <div class="card table-card">
            <div class="card-header">
                <h3>–°–ø–∏—Å–æ–∫ –∂–∏–ª—å—Ü–æ–≤ –∏ –¥–æ–ª–≥–æ–≤</h3>
                <div style="display:flex;gap:10px;align-items:center">
                    <input type="text" id="userSearchInput" placeholder="–ü–æ–∏—Å–∫ –ø–æ –§–ò–û...">
                    <button id="btnRefreshUsers" class="icon-btn refresh" title="–û–±–Ω–æ–≤–∏—Ç—å">‚Üª</button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="sticky-header-table">
                    <thead>
                        <tr>
                            <th style="width:50px">ID</th>
                            <th>–§–ò–û (–õ–æ–≥–∏–Ω)</th>
                            <th>–û–±—â.</th>
                            <th style="color:#c0392b;border-left:2px solid #e5e7eb">–î–æ–ª–≥ 209</th>
                            <th style="color:#27ae60">–ü–µ—Ä–µ–ø–ª. 209</th>
                            <th style="color:#d35400;border-left:2px solid #e5e7eb">–î–æ–ª–≥ 205</th>
                            <th style="color:#27ae60">–ü–µ—Ä–µ–ø–ª. 205</th>
                            <th>–ò—Ç–æ–≥ —Ç–µ–∫.</th>
                            <th style="text-align:right">–î–µ–π—Å—Ç–≤–∏—è</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr><td colspan="9" style="text-align:center;padding:20px;color:#888">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination-footer" style="padding: 15px; border-top: 1px solid #eee; display: flex; justify-content: center; align-items: center; gap: 15px;">
                <button id="btnPrevPage" class="page-btn" disabled>‚Üê –ù–∞–∑–∞–¥</button>
                <span id="pageInfo" style="font-weight: 500; color: #555;">–°—Ç—Ä–∞–Ω–∏—Ü–∞ 1</span>
                <button id="btnNextPage" class="page-btn">–í–ø–µ—Ä–µ–¥ ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- ============================================================== -->
    <!-- –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê                                                 -->
    <!-- ============================================================== -->

    <!-- –ú–æ–¥–∞–ª–∫–∞: –ü—Ä–æ—Ñ–∏–ª—å –§–∏–Ω–∞–Ω—Å–∏—Å—Ç–∞ -->
    <div id="financierProfileModal" class="modal-overlay">
        <div class="modal-window" style="width: 500px;">
            <div class="modal-header">
                <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3>
                <button class="close-icon" onclick="document.getElementById('financierProfileModal').classList.remove('open')">&times;</button>
            </div>
            <div class="modal-form" style="padding: 20px;">

                <div style="background: #f9fafb; padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 20px;">
                    <h4 style="margin-top: 0; margin-bottom: 15px; font-size: 15px; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px;">–ò–∑–º–µ–Ω–∏—Ç—å —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</h4>
                    <form id="financierChangeCredsForm" class="styled-form">
                        <div class="form-group mb-3">
                            <label>–ù–æ–≤—ã–π –ª–æ–≥–∏–Ω (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ –º–µ–Ω—è–µ—Ç–µ)</label>
                            <input type="text" id="finNewLogin" placeholder="–¢–µ–∫—É—â–∏–π –ª–æ–≥–∏–Ω: ...">
                        </div>
                        <div class="form-group mb-3">
                            <label>–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è)</label>
                            <input type="password" id="finOldPass" required>
                        </div>
                        <div class="form-group mb-3">
                            <label>–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</label>
                            <input type="password" id="finNewPass" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" minlength="6">
                        </div>
                        <button type="submit" class="action-btn primary-btn full-width" id="btnSaveFinCreds">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
                    </form>
                </div>

                <div style="background: #f9fafb; padding: 15px; text-align: center; border-radius: 8px; border: 1px dashed #d1d5db;">
                    <h4 style="margin-top: 0; margin-bottom: 10px; font-size: 15px;">–î–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω–∞—è –∑–∞—â–∏—Ç–∞ (2FA)</h4>
                    <p style="font-size: 13px; color: var(--text-secondary); margin-bottom: 15px;">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –¥–ª—è –∑–∞—â–∏—Ç—ã —Å–∏—Å—Ç–µ–º—ã –æ—Ç –≤–∑–ª–æ–º–∞.</p>
                    <button id="btnOpenTotp" class="action-btn" style="background: #4b5563; color: white; width: 100%;">–ù–∞—Å—Ç—Ä–æ–∏—Ç—å 2FA</button>
                </div>

            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞: –ü–ï–†–í–ò–ß–ù–ê–Ø –ù–ê–°–¢–†–û–ô–ö–ê (–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è) -->
    <div id="firstSetupModal" class="modal-overlay" style="z-index: 10000; background: rgba(17, 24, 39, 0.85); backdrop-filter: blur(8px);">
        <div class="modal-window" style="width: 450px;">
            <div class="modal-header" style="background: var(--danger-color); color: white; justify-content: center;">
                <h3 style="font-size: 18px;">‚ö†Ô∏è –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞—â–∏—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞!</h3>
            </div>
            <div class="modal-form">
                <p style="font-size: 14px; color: var(--text-main); margin-bottom: 15px; text-align: center;">
                    –í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. –í —Ü–µ–ª—è—Ö –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å.
                </p>
                <form id="firstSetupForm" class="styled-form">
                    <div class="form-group mb-3">
                        <label>–ù–æ–≤—ã–π –ª–æ–≥–∏–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <input type="text" id="fsNewLogin" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: fin_ivanov">
                    </div>
                    <div class="form-group mb-3">
                        <label>–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –Ω–æ–≤—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π –ø–∞—Ä–æ–ª—å</label>
                        <input type="password" id="fsNewPassword" placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤" minlength="6" required>
                    </div>
                    <button type="submit" class="action-btn success-btn full-width mt-2" id="btnFsSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤–æ–π—Ç–∏</button>
                </form>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª–∫–∞: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ 2FA -->
    <div id="totpModal" class="modal-overlay" style="z-index: 20000;">
        <div class="modal-window" style="width: 400px; text-align: center;">
            <div class="modal-header">
                <h3>–ó–∞—â–∏—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ (2FA)</h3>
                <button id="btnTotpClose" class="close-icon">&times;</button>
            </div>
            <div class="modal-form">
                <p style="font-size: 13px; color: #555; margin-bottom: 15px;">
                    –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR-–∫–æ–¥ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ <b>–Ø–Ω–¥–µ–∫—Å.–ö–ª—é—á</b> –∏–ª–∏ <b>Google Authenticator</b>:
                </p>
                <img id="totpQrImage" src="" alt="QR Code" style="width: 200px; height: 200px; margin: 0 auto; display: none; border: 1px solid #ddd; border-radius: 8px;">
                <p style="font-size: 12px; color: #888; margin-top: 10px;">
                    –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –∫–ª—é—á –≤—Ä—É—á–Ω—É—é:<br> <strong id="totpSecretText" style="color: #333; letter-spacing: 1px; font-size: 14px;"></strong>
                </p>
                <div class="form-group" style="margin-top: 20px; text-align: left;">
                    <label>–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏–∑ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:</label>
                    <input type="text" id="totpCodeInput" placeholder="123456" maxlength="6" style="font-size: 24px; text-align: center; letter-spacing: 8px; font-weight: bold;">
                </div>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button id="btnTotpActivate" class="action-btn success-btn full-width">–í–∫–ª—é—á–∏—Ç—å 2FA</button>
            </div>
        </div>
    </div>

</div>

<!-- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò –õ–û–ì–ò–ö–ê -->
<script type="module">
import { api } from './js/core/api.js';
import { Auth } from './js/core/auth.js';
import { toast, setLoading } from './js/core/dom.js';
import { FinancierApp } from './js/modules/financier.js';
import { TotpSetup } from './js/core/totp.js';

if(!Auth.isAuthenticated()){
    window.location.replace('login.html');
}

document.addEventListener('DOMContentLoaded', async () => {
    // 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–º—è –≤ —à–∞–ø–∫–µ
    const nameEl = document.getElementById('financierName');
    if(nameEl) { nameEl.textContent = `${Auth.getUsername() || '–ó–∞–≥—Ä—É–∑–∫–∞...'}`; }

    // 2. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—ã—Ö–æ–¥–∞
    const logoutBtn = document.querySelector('.logout-btn');
    if(logoutBtn) { logoutBtn.addEventListener('click', () => Auth.logout()); }

    // 3. –¢–∞–±—ã
    const tabs = document.querySelectorAll('.tab-btn');
    const contents = document.querySelectorAll('.tab-content');
    tabs.forEach(btn => {
        btn.addEventListener('click', () => {
            tabs.forEach(t => t.classList.remove('active'));
            contents.forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            const tabId = btn.dataset.tab;
            const tabContent = document.getElementById(tabId);
            if(tabContent) tabContent.classList.add('active');
        });
    });

    // 4. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–æ–¥—É–ª–µ–π
    FinancierApp.init();
    TotpSetup.init();

    // 5. –ü–†–û–í–ï–†–ö–ê –ë–ï–ó–û–ü–ê–°–ù–û–°–¢–ò (–ü–µ—Ä–≤–∏—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞)
    try {
        const user = await api.get('/users/me');
        if(nameEl) nameEl.textContent = user.username; // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–æ—á–Ω–æ –∏–∑ –ë–î

        if (user.is_initial_setup_done === false) {
            const fsModal = document.getElementById('firstSetupModal');
            if (fsModal) fsModal.classList.add('open');
        }
    } catch (e) {
        console.warn('Security check failed', e);
    }

    // 6. –õ–æ–≥–∏–∫–∞ —Ñ–æ—Ä–º—ã –ü–µ—Ä–≤–∏—á–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    const fsForm = document.getElementById('firstSetupForm');
    if (fsForm) {
        fsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnFsSave');
            const newLogin = document.getElementById('fsNewLogin').value.trim();
            const newPass = document.getElementById('fsNewPassword').value;

            setLoading(btn, true, '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
            try {
                const payload = { new_password: newPass };
                if (newLogin) payload.new_username = newLogin;

                await api.post('/users/me/setup', payload);

                alert('–î–∞–Ω–Ω—ã–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –∑–∞–Ω–æ–≤–æ.');
                Auth.logout();
            } catch (err) {
                toast(err.message, 'error');
                setLoading(btn, false, '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –≤–æ–π—Ç–∏');
            }
        });
    }

    // 7. –õ–æ–≥–∏–∫–∞ –ü—Ä–æ—Ñ–∏–ª—è (–ú–æ–¥–∞–ª–∫–∞)
    const profileBtn = document.getElementById('btnOpenFinancierProfile');
    const profileModal = document.getElementById('financierProfileModal');
    if (profileBtn && profileModal) {
        profileBtn.addEventListener('click', () => profileModal.classList.add('open'));
    }

    const changeCredsForm = document.getElementById('financierChangeCredsForm');
    if (changeCredsForm) {
        changeCredsForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSaveFinCreds');

            const newLogin = document.getElementById('finNewLogin').value.trim();
            const oldPass = document.getElementById('finOldPass').value;
            const newPass = document.getElementById('finNewPass').value;

            setLoading(btn, true, '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
            try {
                const user = await api.get('/users/me');

                // –ú–µ–Ω—è–µ–º –ø–∞—Ä–æ–ª—å
                if (newPass) {
                    await api.post('/users/me/change-password', {
                        old_password: oldPass,
                        new_password: newPass
                    });
                }

                // –ú–µ–Ω—è–µ–º –ª–æ–≥–∏–Ω (—Ñ–∏–Ω–∞–Ω—Å–∏—Å—Ç—É —Ç–æ–∂–µ —Ä–∞–∑—Ä–µ—à–∏–º –º–µ–Ω—è—Ç—å —Å–≤–æ–π –ª–æ–≥–∏–Ω —á–µ—Ä–µ–∑ –æ–±—â–∏–π –º–µ—Ç–æ–¥)
                if (newLogin && newLogin !== user.username) {
                    await api.put(`/users/${user.id}`, { username: newLogin });
                    Auth.setSession(user.role, newLogin);
                    if(nameEl) nameEl.textContent = newLogin;
                }

                toast('–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
                changeCredsForm.reset();
                profileModal.classList.remove('open');

            } catch (err) {
                toast(err.message, 'error');
            } finally {
                setLoading(btn, false, '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è');
            }
        });
    }
});
</script>
</body>
</html>