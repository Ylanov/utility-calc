<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –∂–∏–ª—å—Ü–∞</title>

    <!-- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Tailwind CSS –¥–ª—è —Å—Ç–∏–ª–µ–π -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤: —Ç–æ—Å—Ç—ã, —Å–ø–∏–Ω–Ω–µ—Ä—ã –∏ —Ç.–¥. -->
    <style>
        body {
            background: linear-gradient(135deg, #f0f4f8, #e6f3e6);
            min-height: 100vh;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π (—Ç–æ—Å—Ç–æ–≤) */
        #toast-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .toast {
            padding: 12px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-success { background-color: #27ae60; }
        .toast-error { background-color: #c0392b; }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —Å–ø–∏–Ω–Ω–µ—Ä–∞ –∑–∞–≥—Ä—É–∑–∫–∏ */
        .spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* –ö–ª–∞—Å—Å –¥–ª—è –Ω–µ–≤–∞–ª–∏–¥–Ω–æ–≥–æ –ø–æ–ª—è –≤–≤–æ–¥–∞ */
        .input-error {
            border-color: #c0392b !important;
            box-shadow: 0 0 0 1px #c0392b;
        }
    </style>
</head>

<body class="font-sans text-gray-800">

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ç–æ—Å—Ç–æ–≤ -->
<div id="toast-container"></div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<div id="app-container" class="max-w-6xl mx-auto p-4 opacity-0 transition-opacity duration-500">

    <!-- ================= HEADER ================= -->
    <header class="flex justify-between items-center bg-white shadow-md rounded-xl p-4 mb-6">
        <div>
            <h1 class="text-2xl font-bold text-gray-800">üè† –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h1>
            <p class="text-sm text-gray-500">–ñ–ö–• ‚Äî —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è–º–∏</p>
        </div>
        <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white font-semibold px-4 py-2 rounded-lg transition-colors">
            –í—ã–π—Ç–∏
        </button>
    </header>

    <!-- ================= PROFILE ================= -->
    <div class="bg-white shadow-md rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-x-4 gap-y-6 text-sm">
            <div>
                <div class="text-gray-500">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                <div id="pUser" class="font-bold text-lg">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div>
                <div class="text-gray-500">–ê–¥—Ä–µ—Å</div>
                <div id="pAddress" class="font-semibold">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div>
                <div class="text-gray-500">–ü–ª–æ—â–∞–¥—å</div>
                <div id="pArea" class="font-semibold">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div>
                <div class="text-gray-500">–ö–æ–ª-–≤–æ –∂–∏–ª—å—Ü–æ–≤</div>
                <div id="pResidents" class="font-semibold">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            <div>
                <div class="text-gray-500">–¢–µ–∫—É—â–∏–π –ø–µ—Ä–∏–æ–¥</div>
                <div id="pPeriod" class="font-bold text-blue-600">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
        </div>
    </div>

    <!-- ================= STATUS ================= -->
    <div id="statusArea" class="mb-6"></div>

    <!-- ================= METERS ================= -->
    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">üìä –í–≤–æ–¥ –ø–æ–∫–∞–∑–∞–Ω–∏–π</h2>
        <!-- –ò—Å–ø–æ–ª—å–∑—É–µ–º fieldset, —á—Ç–æ–±—ã –ª–µ–≥–∫–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é —Ñ–æ—Ä–º—É -->
        <fieldset id="meterFieldset">
            <form id="meterForm" class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- HOT WATER -->
                    <div class="border rounded-lg p-4 bg-gray-50 flex flex-col">
                        <h3 class="font-semibold text-red-600">üî• –ì–æ—Ä—è—á–∞—è –≤–æ–¥–∞ (–º¬≥)</h3>
                        <div class="mt-2 text-sm text-gray-600">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ:</div>
                        <div id="prevHot" class="text-2xl font-bold text-gray-700">0.00</div>
                        <label for="hotWater" class="mt-4 text-sm font-medium">–¢–µ–∫—É—â–µ–µ:</label>
                        <input id="hotWater" type="number" step="0.01" min="0" class="mt-1 w-full border-gray-300 rounded-lg px-3 py-2 transition focus:border-red-500 focus:ring-red-500" required>
                        <span id="hotError" class="text-red-600 text-xs mt-1 h-4"></span>
                    </div>

                    <!-- COLD WATER -->
                    <div class="border rounded-lg p-4 bg-gray-50 flex flex-col">
                        <h3 class="font-semibold text-blue-600">‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω–∞—è –≤–æ–¥–∞ (–º¬≥)</h3>
                        <div class="mt-2 text-sm text-gray-600">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ:</div>
                        <div id="prevCold" class="text-2xl font-bold text-gray-700">0.00</div>
                        <label for="coldWater" class="mt-4 text-sm font-medium">–¢–µ–∫—É—â–µ–µ:</label>
                        <input id="coldWater" type="number" step="0.01" min="0" class="mt-1 w-full border-gray-300 rounded-lg px-3 py-2 transition focus:border-blue-500 focus:ring-blue-500" required>
                        <span id="coldError" class="text-red-600 text-xs mt-1 h-4"></span>
                    </div>

                    <!-- ELECTRICITY -->
                    <div class="border rounded-lg p-4 bg-gray-50 flex flex-col">
                        <h3 class="font-semibold text-yellow-500">‚ö° –≠–ª–µ–∫—Ç—Ä–∏—á–µ—Å—Ç–≤–æ (–∫–í—Ç*—á)</h3>
                        <div class="mt-2 text-sm text-gray-600">–ü—Ä–µ–¥—ã–¥—É—â–µ–µ:</div>
                        <div id="prevElect" class="text-2xl font-bold text-gray-700">0.00</div>
                        <label for="electricity" class="mt-4 text-sm font-medium">–¢–µ–∫—É—â–µ–µ:</label>
                        <input id="electricity" type="number" step="0.01" min="0" class="mt-1 w-full border-gray-300 rounded-lg px-3 py-2 transition focus:border-yellow-500 focus:ring-yellow-500" required>
                        <span id="electError" class="text-red-600 text-xs mt-1 h-4"></span>
                    </div>
                </div>

                <div class="text-center pt-4">
                    <button id="submitBtn" type="submit" class="bg-green-600 hover:bg-green-700 text-white px-8 py-3 rounded-xl shadow-lg text-lg font-semibold transition-all duration-300 flex items-center justify-center mx-auto disabled:bg-gray-400 disabled:cursor-not-allowed">
                        <span id="submitBtnText">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</span>
                        <div id="submitBtnSpinner" class="spinner hidden"></div>
                    </button>
                </div>
            </form>
        </fieldset>
    </div>

    <!-- ================= RESULT ================= -->
    <div id="result" class="hidden bg-white rounded-xl shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">üí∞ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è</h2>
        <ul class="divide-y divide-gray-200">
            <li class="flex justify-between py-2"><span>–ì–í–°</span><span id="rHot" class="font-medium"></span></li>
            <li class="flex justify-between py-2"><span>–•–í–°</span><span id="rCold" class="font-medium"></span></li>
            <li class="flex justify-between py-2"><span>–í–æ–¥–æ–æ—Ç–≤–µ–¥–µ–Ω–∏–µ</span><span id="rSew" class="font-medium"></span></li>
            <li class="flex justify-between py-2"><span>–≠–ª–µ–∫—Ç—Ä–æ—ç–Ω–µ—Ä–≥–∏—è</span><span id="rEl" class="font-medium"></span></li>
            <li class="flex justify-between py-2"><span>–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –∏ —Ä–µ–º–æ–Ω—Ç</span><span id="rMain" class="font-medium"></span></li>
            <li class="flex justify-between py-2"><span>–°–æ—Ü. –Ω–∞–µ–º</span><span id="rRent" class="font-medium"></span></li>
            <li class="flex justify-between py-2"><span>–í—ã–≤–æ–∑ –º—É—Å–æ—Ä–∞ (–¢–ö–û)</span><span id="rWaste" class="font-medium"></span></li>
            <li class="flex justify-between py-2"><span>–û—Ç–æ–ø–ª–µ–Ω–∏–µ –∏ –û–î–ù</span><span id="rFix" class="font-medium"></span></li>
            <li class="flex justify-between py-4 text-xl font-bold text-green-700 border-t-2 mt-2 border-green-200">
                <span>–ò–¢–û–ì–û</span><span id="rTotal"></span>
            </li>
        </ul>
    </div>

    <!-- ================= HISTORY ================= -->
    <div class="bg-white shadow-md rounded-xl p-6 mb-6">
        <h2 class="text-xl font-semibold mb-4 text-gray-700 border-b pb-2">üìö –ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π</h2>
        <div class="overflow-x-auto">
            <table class="w-full text-sm border">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="p-2 border font-medium text-left">–ü–µ—Ä–∏–æ–¥</th>
                        <th class="p-2 border font-medium">–ì–í–° (–º¬≥)</th>
                        <th class="p-2 border font-medium">–•–í–° (–º¬≥)</th>
                        <th class="p-2 border font-medium">–°–≤–µ—Ç (–∫–í—Ç*—á)</th>
                        <th class="p-2 border font-medium">–ò—Ç–æ–≥–æ (—Ä—É–±.)</th>
                        <th class="p-2 border font-medium">–ö–≤–∏—Ç–∞–Ω—Ü–∏—è</th>
                    </tr>
                </thead>
                <tbody id="historyBody" class="divide-y">
                    <!-- –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ================= SCRIPT ================= -->
<script>
    'use strict';

    // ===================================================================
    // 1. –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –ò –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
    // ===================================================================
    const appState = {
        token: localStorage.getItem('token'),
        lastReadings: { hot: 0, cold: 0, elect: 0 },
        isPeriodActive: false
    };

    // ===================================================================
    // 2. –°–ï–†–í–ò–° –î–õ–Ø –†–ê–ë–û–¢–´ –° API
    // ===================================================================
    const apiService = {
        async request(endpoint, options = {}) {
            const defaultOptions = {
                headers: {
                    'Authorization': `Bearer ${appState.token}`,
                    'Content-Type': 'application/json'
                }
            };
            const config = { ...defaultOptions, ...options };

            try {
                const response = await fetch(endpoint, config);
                if (response.status === 401) {
                    logout(); // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –Ω–µ–≤–∞–ª–∏–¥–µ–Ω, –≤—ã—Ö–æ–¥–∏–º
                    return;
                }
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ detail: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞' }));
                    throw new Error(errorData.detail || `–û—à–∏–±–∫–∞ ${response.status}`);
                }
                // –î–ª—è DELETE –∑–∞–ø—Ä–æ—Å–æ–≤, —É –∫–æ—Ç–æ—Ä—ã—Ö –º–æ–∂–µ—Ç –Ω–µ –±—ã—Ç—å —Ç–µ–ª–∞
                if (response.status === 204) return null;
                // –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤
                if (options.isBlob) return await response.blob();

                return await response.json();
            } catch (error) {
                console.error(`API Error on ${endpoint}:`, error);
                throw error; // –ü–µ—Ä–µ–¥–∞–µ–º –æ—à–∏–±–∫—É –¥–∞–ª—å—à–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤ UI
            }
        },
        get(endpoint) {
            return this.request(endpoint);
        },
        post(endpoint, body) {
            return this.request(endpoint, { method: 'POST', body: JSON.stringify(body) });
        },
        download(endpoint) {
            return this.request(endpoint, { isBlob: true });
        }
    };

    // ===================================================================
    // 3. –§–£–ù–ö–¶–ò–ò –û–ë–ù–û–í–õ–ï–ù–ò–Ø –ò–ù–¢–ï–†–§–ï–ô–°–ê (UI)
    // ===================================================================
    const uiUpdater = {
        updateProfile(data) {
            document.getElementById('pUser').textContent = data.username || '-';
            document.getElementById('pAddress').textContent = data.dormitory || '-';
            document.getElementById('pArea').textContent = `${data.apartment_area} –º¬≤`;
            document.getElementById('pResidents').textContent = data.residents_count;
            document.getElementById('pPeriod').textContent = data.period_name || '–ü—Ä–∏–µ–º –∑–∞–∫—Ä—ã—Ç';
        },
        updateMeters(data) {
            appState.lastReadings = { hot: data.prev_hot, cold: data.prev_cold, elect: data.prev_elect };
            document.getElementById('prevHot').textContent = data.prev_hot.toFixed(2);
            document.getElementById('prevCold').textContent = data.prev_cold.toFixed(2);
            document.getElementById('prevElect').textContent = data.prev_elect.toFixed(2);

            if (data.is_draft) {
                document.getElementById('hotWater').value = data.current_hot || '';
                document.getElementById('coldWater').value = data.current_cold || '';
                document.getElementById('electricity').value = data.current_elect || '';
            }
        },
        updateStatus(data) {
            appState.isPeriodActive = data.is_draft;
            const statusArea = document.getElementById('statusArea');
            const meterFieldset = document.getElementById('meterFieldset');

            if (data.is_draft) {
                statusArea.innerHTML = `
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-md" role="alert">
                        <p class="font-bold">‚úèÔ∏è –ß–µ—Ä–Ω–æ–≤–∏–∫ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–µ</p>
                        <p>–í–∞—à–∏ –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ –æ–∂–∏–¥–∞—é—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –±—É—Ö–≥–∞–ª—Ç–µ—Ä–æ–º.</p>
                    </div>`;
                meterFieldset.disabled = false;
            } else {
                statusArea.innerHTML = `
                    <div class="bg-blue-100 border-l-4 border-blue-500 text-blue-700 p-4 rounded-md" role="alert">
                        <p class="font-bold">üîí –†–∞—Å—á–µ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–∫—Ä—ã—Ç</p>
                        <p>–ü–æ–¥–∞—á–∞ –ø–æ–∫–∞–∑–∞–Ω–∏–π –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –ù–æ–≤—ã–µ –ø–æ–∫–∞–∑–∞–Ω–∏—è –º–æ–∂–Ω–æ –±—É–¥–µ—Ç –ø–æ–¥–∞—Ç—å –≤ —Å–ª–µ–¥—É—é—â–µ–º –ø–µ—Ä–∏–æ–¥–µ.</p>
                    </div>`;
                meterFieldset.disabled = true;
            }
        },
        updateResults(data) {
            const resultDiv = document.getElementById('result');
            if (!data.total_cost) {
                resultDiv.classList.add('hidden');
                return;
            }
            resultDiv.classList.remove('hidden');
            const formatCurrency = (value) => `${(value || 0).toFixed(2)} ‚ÇΩ`;
            document.getElementById('rHot').textContent = formatCurrency(data.cost_hot_water);
            document.getElementById('rCold').textContent = formatCurrency(data.cost_cold_water);
            document.getElementById('rSew').textContent = formatCurrency(data.cost_sewage);
            document.getElementById('rEl').textContent = formatCurrency(data.cost_electricity);
            document.getElementById('rMain').textContent = formatCurrency(data.cost_maintenance);
            document.getElementById('rRent').textContent = formatCurrency(data.cost_social_rent);
            document.getElementById('rWaste').textContent = formatCurrency(data.cost_waste);
            document.getElementById('rFix').textContent = formatCurrency(data.cost_fixed_part);
            document.getElementById('rTotal').textContent = formatCurrency(data.total_cost);
        },
        updateHistory(historyData) {
            const historyBody = document.getElementById('historyBody');
            historyBody.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º
            if (!historyData || historyData.length === 0) {
                historyBody.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">–ò—Å—Ç–æ—Ä–∏—è –Ω–∞—á–∏—Å–ª–µ–Ω–∏–π –ø—É—Å—Ç–∞.</td></tr>`;
                return;
            }
            historyData.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50';
                tr.innerHTML = `
                    <td class="border p-2 font-semibold">${r.period}</td>
                    <td class="border p-2 text-center">${r.hot.toFixed(2)}</td>
                    <td class="border p-2 text-center">${r.cold.toFixed(2)}</td>
                    <td class="border p-2 text-center">${r.electric.toFixed(2)}</td>
                    <td class="border p-2 text-center font-bold text-green-800">${r.total.toFixed(2)}</td>
                    <td class="border p-2 text-center">
                        <button onclick="downloadHistoryReceipt(${r.id})" class="text-blue-600 hover:underline text-2xl" title="–°–∫–∞—á–∞—Ç—å –∫–≤–∏—Ç–∞–Ω—Ü–∏—é">üìÑ</button>
                    </td>`;
                historyBody.appendChild(tr);
            });
        },
        showLoader(isLoading) {
            document.getElementById('app-container').style.opacity = isLoading ? '0' : '1';
        },
        showToast(message, isError = false) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${isError ? 'toast-error' : 'toast-success'}`;
            toast.textContent = message;
            container.appendChild(toast);

            setTimeout(() => toast.classList.add('show'), 10); // –î–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –ø–æ—è–≤–ª–µ–Ω–∏—è
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, 3000);
        }
    };

    // ===================================================================
    // 4. –õ–û–ì–ò–ö–ê –ò –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô
    // ===================================================================
    function logout() {
        localStorage.removeItem('token');
        window.location.href = 'login.html';
    }

    function validateInputs() {
        let isFormValid = true;
        const inputs = [
            { id: 'hotWater', prev: appState.lastReadings.hot, errorId: 'hotError', name: '–ì–í–°' },
            { id: 'coldWater', prev: appState.lastReadings.cold, errorId: 'coldError', name: '–•–í–°' },
            { id: 'electricity', prev: appState.lastReadings.elect, errorId: 'electError', name: '–°–≤–µ—Ç' }
        ];

        inputs.forEach(item => {
            const inputEl = document.getElementById(item.id);
            const errorEl = document.getElementById(item.errorId);
            const value = parseFloat(inputEl.value);

            if (inputEl.value && value < item.prev) {
                inputEl.classList.add('input-error');
                errorEl.textContent = `–ó–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ ${item.prev.toFixed(2)}`;
                isFormValid = false;
            } else {
                inputEl.classList.remove('input-error');
                errorEl.textContent = '';
            }
        });
        document.getElementById('submitBtn').disabled = !isFormValid;
        return isFormValid;
    }

    async function handleFormSubmit(event) {
        event.preventDefault();
        if (!validateInputs()) return;

        const submitBtn = document.getElementById('submitBtn');
        const btnText = document.getElementById('submitBtnText');
        const btnSpinner = document.getElementById('submitBtnSpinner');

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
        submitBtn.disabled = true;
        btnText.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
        btnSpinner.classList.remove('hidden');

        const data = {
            hot_water: parseFloat(document.getElementById('hotWater').value),
            cold_water: parseFloat(document.getElementById('coldWater').value),
            electricity: parseFloat(document.getElementById('electricity').value)
        };

        try {
            await apiService.post('/api/calculate', data);
            uiUpdater.showToast('–ü–æ–∫–∞–∑–∞–Ω–∏—è —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!', false);
            await loadInitialState(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
            await loadHistory();
        } catch (error) {
            uiUpdater.showToast(error.message, true);
        } finally {
            // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            submitBtn.disabled = false;
            btnText.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            btnSpinner.classList.add('hidden');
        }
    }

    function downloadFile(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    async function downloadHistoryReceipt(readingId) {
        try {
            const blob = await apiService.download(`/api/client/receipts/${readingId}`);
            downloadFile(blob, `receipt_${readingId}.pdf`);
        } catch (error) {
            uiUpdater.showToast('–ö–≤–∏—Ç–∞–Ω—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.', true);
        }
    }

    // ===================================================================
    // 5. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
    // ===================================================================
    async function loadInitialState() {
        try {
            const stateData = await apiService.get('/api/readings/state');
            if (stateData) {
                uiUpdater.updateProfile(stateData);
                uiUpdater.updateStatus(stateData);
                uiUpdater.updateMeters(stateData);
                uiUpdater.updateResults(stateData);
                validateInputs(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–Ω–ø—É—Ç—ã –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
            }
        } catch (error) {
            uiUpdater.showToast(error.message, true);
        }
    }

    async function loadHistory() {
        try {
            const historyData = await apiService.get('/api/readings/history');
            uiUpdater.updateHistory(historyData);
        } catch (error) {
            // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É, —Ç.–∫. —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ
            console.error("Could not load history:", error);
        }
    }

    // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è, –∑–∞–ø—É—Å–∫–∞—é—â–∞—è –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
    async function main() {
        if (!appState.token) {
            logout();
            return;
        }

        await loadInitialState();
        await loadHistory();

        uiUpdater.showLoader(false); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–Ω—Ç –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏

        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
        document.getElementById('meterForm').addEventListener('submit', handleFormSubmit);
        document.getElementById('hotWater').addEventListener('input', validateInputs);
        document.getElementById('coldWater').addEventListener('input', validateInputs);
        document.getElementById('electricity').addEventListener('input', validateInputs);
    }

    document.addEventListener('DOMContentLoaded', main);

</script>

</body>
</html>